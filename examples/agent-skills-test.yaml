# Agent Skills Test
# Demonstrates loading and using Agent Skills with agent-benchmark
#
# This test verifies that:
# 1. Skills are loaded from SKILL.md files
# 2. Skill content is injected into system prompt
# 3. Agents can use skill instructions
# 4. Built-in tools auto-enable when skill has @references/ folder
#
# Prerequisites:
# - Azure OpenAI resource with Entra ID authentication
# - Environment variable: AZURE_OPENAI_ENDPOINT
# - Node.js installed (for MCP filesystem server)
#
# Run command:
#   agent-benchmark -f examples/agent-skills-test.yaml -reportType html,json

criteria:
  success_rate: 1 # 100%

providers:
  - name: azure-openai
    type: AZURE
    auth_type: entra_id
    model: gpt-4.1
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview

servers:
  - name: filesystem
    type: stdio
    command: npx -y @modelcontextprotocol/server-filesystem {{TEST_DIR}}

agents:
  - name: skilled-agent
    provider: azure-openai
    skill:
      path: "{{TEST_DIR}}/skills/demo-skill"  # Path to skill folder
    system_prompt: |
      You are {{AGENT_NAME}}, a helpful assistant with access to reference docs.
      
      IMPORTANT: When asked about references, use the available tools to list 
      and read them. Execute all tasks directly without asking for clarification.
    servers:
      - name: filesystem

settings:
  verbose: true
  max_iterations: 10
  test_delay: 2s

sessions:
  - name: "Skill Verification"
    tests:
      - name: "Verify skill is loaded"
        prompt: |
          What skill do you have activated? 
          Start your response with the greeting specified in your skill instructions.
        assertions:
          # The skill instructs to greet with "Demo Skill activated!"
          - type: output_regex
            pattern: "(?i)demo.*(skill|activated)"

      - name: "Verify skill metadata knowledge"
        prompt: |
          What is the purpose of your activated skill according to its description?
        assertions:
          # Should reference the skill's purpose (demonstration, testing, template)
          - type: output_regex
            pattern: "(?i)(demonstrat|template|test|example)"

  - name: "Reference Access"
    tests:
      - name: "List skill references"
        prompt: |
          List all the reference files available in your skill directory.
          Use the list_skill_references tool.
        assertions:
          - type: tool_called
            tool: list_skill_references
          - type: output_contains
            value: "guide.md"

      - name: "Read skill reference"
        prompt: |
          Read the guide.md reference file and tell me the three numbered 
          "Additional Instructions" from that file.
        assertions:
          - type: tool_called
            tool: read_skill_reference
          - anyOf:
              - type: output_regex
                pattern: "(?i)polite|helpful"
              - type: output_regex
                pattern: "(?i)confirm.*understanding"
              - type: output_regex
                pattern: "(?i)report.*results"
