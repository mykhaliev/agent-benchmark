# Tests for Chrome devtools MCP
# https://github.com/ChromeDevTools/chrome-devtools-mcp/
# Test scenario:
# 1. Open the page https://broken-workshop.dequelabs.com:
# 2. Click the button with span "Cook Mega Burger"
criteria:
  success_rate: 1 # 100%
providers:
  - name: vertex-flash
    type: VERTEX
    project_id: <your-project-id>
    credentials_path: <path to your credentials.json>
    model: gemini-2.5-flash
servers:
  - name: chrome-mcp
    type: stdio
    command: npx -y chrome-devtools-mcp@latest
agents:
  - name: gemini-2.5-flash-agent
    servers:
      - name: chrome-mcp
    provider: vertex-flash
settings:
  verbose: true # enable debug logs
  max_iterations: 20 # max llm iterations per prompt
  test_delay: 1s # delay between tests
  tool_timeout: 1s # max tool call duration
sessions:
  - name: Open website and do click
    tests:
      - name: "Open website and do click"
        prompt: |
          Follow these steps exactly and use the correct tools with valid inputs:
          1. Open the page https://broken-workshop.dequelabs.com:
          2. Click the button with span "Cook Mega Burger"
        assertions:
          # Verify that new_page tool was invoked at least once
          - type: tool_called
            tool: "new_page"

          # Verify the exact URL parameter passed to new_page tool
          - type: tool_param_equals
            tool: "new_page"
            params:
              url: "https://broken-workshop.dequelabs.com"

          # Verify URL parameter matches the expected domain pattern
          - type: tool_param_matches_regex
            tool: "new_page"
            params:
              url: "^https://broken-workshop\\.dequelabs\\.com"

          # Verify that click tool was invoked at least once
          - type: tool_called
            tool: "click"

          # Verify the click target contains the correct button text
          - type: tool_param_matches_regex
            tool: "click"
            params:
              selector: "(?i)cook.*mega.*burger"

          # Verify exactly 2 tool calls were made (new_page + click)
          - type: tool_call_count
            value: 2

          # Verify tools were called in the correct sequence
          - type: tool_call_order
            sequence:
              - new_page
              - click

          # Verify new_page was not called more than once (no redundant navigation)
          - type: tool_not_called_more_than
            tool: "new_page"
            value: 1

          # Verify no invalid/hallucinated tools were called
          - type: no_hallucinated_tools

          # Verify the agent didn't generate error messages during execution
          - type: no_error_messages

          # Verify total token usage is under 2000 (efficiency check)
          - type: max_tokens
            value: 2000

          # Verify total execution time is under 10 seconds (performance check)
          - type: max_latency_ms
            value: 10000

          # Verify click tool execution didn't exceed 5 seconds
          - type: max_latency_ms
            tool: "click"
            value: 5000

          # Verify the output contains confirmation of successful page load
          - type: output_contains
            tool: "new_page"
            value: "loaded"

          # Verify the output doesn't contain error indicators
          - type: output_not_contains
            tool: "click"
            value: "failed"

          # Verify the output matches success pattern (case-insensitive)
          - type: output_regex
            tool: "click"
            pattern: "(?i)(success|clicked|complete)"

          # Verify new_page result contains the expected page title in JSON response
          - type: tool_result_matches_json
            tool: "new_page"
            path: "$.title"
            value: "Broken Workshop"