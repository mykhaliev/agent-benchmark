# Windows based test
# Tests a UI Automation scenario with Windows MCP Server
# https://windowsmcpserver.dev/
# https://github.com/sbroenne/mcp-windows
#
# Testing framework: Agent Benchmark
# https://github.com/mykhaliev/agent-benchmark
#
# Test: Complete Notepad workflow with proof
# Success = proof provided + Notepad closed
#
# Prerequisites:
# - Windows 10/11
# - Windows MCP Server executable in examples folder
# - Azure OpenAI resource with Entra ID authentication configured
# - One of the following authentication methods:
#   * Azure CLI logged in (az login)
#   * Environment variables: AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_CLIENT_SECRET
#   * Managed Identity (when running in Azure)
#   * Visual Studio Code Azure Account extension
# - Environment variables set:
#   - AZURE_OPENAI_ENDPOINT: Azure OpenAI endpoint
#
# Run command:
#   go run . -f examples/windows-mcp-server-test.yaml -reportType html,json

criteria:
  success_rate: 1 # 100%

providers:
  - name: azure-openai-gpt5
    type: AZURE
    auth_type: entra_id  # Uses DefaultAzureCredential - no API key needed
    model: gpt-5-chat
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview
    rate_limits:
      tpm: 150000  # Tokens per minute limit
      rpm: 900     # Requests per minute limit
      max_rate_limit_retries: 1  # Stop after 1 rate limit retry

  - name: azure-openai-gpt4o
    type: AZURE
    auth_type: entra_id  # Uses DefaultAzureCredential - no API key needed
    model: gpt-4o
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview
    rate_limits:
      tpm: 150000  # Tokens per minute limit
      rpm: 900     # Requests per minute limit
      max_rate_limit_retries: 1  # Stop after 1 rate limit retry

servers:
  - name: windows-mcp
    type: stdio
    command: ./examples/Sbroenne.WindowsMcp.exe
    server_delay: 10s

agents:
  - name: gpt5-agent
    servers:
      - name: windows-mcp
    provider: azure-openai-gpt5
    system_prompt: |
      You are {{AGENT_NAME}}, an autonomous Windows automation agent using {{PROVIDER_NAME}}.
      Session: {{SESSION_NAME}}
      
      CRITICAL RULES:
      - Execute all tasks IMMEDIATELY without asking for confirmation
      - NEVER ask "Would you like me to...", "Should I proceed...", or similar questions
      - NEVER request clarification - make reasonable assumptions and proceed
      - Use available tools directly to complete the requested tasks
      - Report results after completion, not before starting
    clarification_detection:
      enabled: true
      level: warning
      use_builtin_patterns: true

  - name: gpt4o-agent
    servers:
      - name: windows-mcp
    provider: azure-openai-gpt4o
    system_prompt: |
      You are {{AGENT_NAME}}, an autonomous Windows automation agent using {{PROVIDER_NAME}}.
      Session: {{SESSION_NAME}}
      
      CRITICAL RULES:
      - Execute all tasks IMMEDIATELY without asking for confirmation
      - NEVER ask "Would you like me to...", "Should I proceed...", or similar questions
      - NEVER request clarification - make reasonable assumptions and proceed
      - Use available tools directly to complete the requested tasks
      - Report results after completion, not before starting
    clarification_detection:
      enabled: true
      level: warning
      use_builtin_patterns: true

settings:
  verbose: true
  max_iterations: 10      # launch + type + close + dialog + verify + buffer
  test_delay: 60s         # Longer delay to avoid rate limits between agents

sessions:
  - name: Notepad Workflow
    tests:
      - name: "Complete Notepad automation"
        description: "Open Notepad, type text, close without saving"
        prompt: |
          1. Launch Notepad
          2. Type "Hello World"
          3. Record proof that this worked (no screenshots, just text)
          4. Close Notepad and click "Don't Save" if prompted
          5. Verify no Notepad window is open (search for it)
          
          Report "VERIFIED: No Notepad window open" if closed successfully.
        assertions:
          # OUTCOME: LLM verified no Notepad window open
          - type: output_regex
            pattern: "(?i)(no.*(notepad|window).*(open|found|running)|verified|notepad.*(closed|not found))"

          # OUTCOME: Proof that "Hello World" was typed (via output OR tool params)
          - anyOf:
              - type: output_regex
                pattern: "(?i)hello\\s*world"
              - type: tool_param_matches_regex
                tool: keyboard_control
                params:
                  text: "(?i)hello.*world"
              - type: tool_param_matches_regex
                tool: ui_type
                params:
                  text: "(?i)hello.*world"

          # SAFETY: No failure indicators
          - type: output_not_contains
            value: "failed"

          # QUALITY: Only used real tools
          - type: no_hallucinated_tools

          # QUALITY: No errors during execution
          - type: no_error_messages

          # REQUIRED: Must use app tool to launch Notepad
          - type: tool_called
            tool: app

          # VERIFY: Notepad was launched (check output or tool result)
          - type: tool_result_matches_json
            tool: app
            path: "$.ok"
            value: true

          # FLEXIBLE: Text input can use different tools depending on the LLM
          # May use keyboard_control or ui_type
          - anyOf:
              - type: tool_called
                tool: keyboard_control
              - type: tool_called
                tool: ui_type

          # VERIFY: Window was closed (find returned empty or no matches)
          - anyOf:
              # Either the output confirms closure
              - type: output_regex
                pattern: "(?i)(no.*windows?.*found|0.*windows?|empty.*list|windows.*\\[\\])"

          # PERFORMANCE: Complete within 60 seconds
          - type: max_latency_ms
            value: 60000
          
          # EFFICIENCY: Stay under token limits
          - type: max_tokens
            value: 60000

