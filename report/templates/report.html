{{/*
    Main Report Template
    
    This template composes modular building blocks for the full report.
    It adapts to both single-agent and multi-agent views using shared components.
    
    Template Definitions (20 total):
    - summary-cards: Summary statistics grid
    - test-overview: Single-agent multiple tests overview table
    - comparison-matrix: Multi-agent test √ó agent results matrix
    - agent-leaderboard: Agent ranking table with success rates
    - file-summary: Source file grouping summary
    - session-summary: Session grouping with diagrams
    - test-results: Container for all test groups
    - test-group: Single test with single or multi-agent view
    - multi-agent-comparison: Horizontal agent comparison table
    - tool-comparison: Side-by-side tool call comparison
    - sequence-comparison: Side-by-side execution flow diagrams
    - single-agent-detail: Full details for one agent run
    - agent-assertions: Assertions list with pass/fail status
    - agent-errors: Error messages display
    - agent-sequence-diagram: Mermaid execution flow
    - agent-tool-calls: Tool call timeline with parameters
    - agent-messages: Conversation history
    - agent-final-output: Final agent output
    - fullscreen-overlay: Overlays for diagrams and details
    - scripts: JavaScript for interactivity
*/}}

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test Results - Agent Benchmark</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@12/marked.min.js"></script>
    <style>
{{.CSS}}
    </style>
</head>
<body>
    <div class="container">
        <header class="report-header">
            <h1>üß™ Agent Benchmark Report</h1>
            <div class="report-meta">
                <span>üì¶ Version: {{.Version}}</span>
                <span>üìÖ Generated: {{.GeneratedAt}}</span>
                {{if .ShowSuiteInfo}}
                <span>üìÅ Suite: {{if .SuiteName}}{{.SuiteName}}{{else}}Test Suite{{end}}</span>
                {{end}}
                {{if .Adaptive.Flags.ShowFileHeaders}}
                <span>üìÑ Files: {{.Adaptive.Flags.FileCount}}</span>
                {{end}}
            </div>
        </header>

        <!-- Summary Cards -->
        {{template "summary-cards" .}}
        
        {{/* AI Summary - LLM-generated executive summary */}}
        {{if .HasAISummary}}
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">ü§ñ AI Summary</h2>
            </div>
            <div class="section-body">
                <div class="analysis-content markdown-content">{{.AISummary | safeHTML}}</div>
            </div>
        </section>
        {{end}}

        <!-- Test Overview (for single-agent with multiple tests) -->
        {{if .Adaptive.Flags.ShowTestOverview}}
        {{template "test-overview" .}}
        {{end}}

        <!-- Comparison Matrix (only for multi-agent runs) -->
        {{if and .Adaptive.Flags.ShowMatrix (gt (len .Matrix.TestNames) 0)}}
        {{template "comparison-matrix" .}}
        {{end}}
        
        <!-- Agent Leaderboard (only for multi-agent runs) -->
        {{if .Adaptive.Flags.ShowLeaderboard}}
        {{template "agent-leaderboard" .}}
        {{end}}

        {{if .Adaptive.Flags.ShowFileHeaders}}
        {{template "file-summary" .}}
        {{end}}

        <!-- Detailed Test Results (includes session grouping when sessions > 1) -->
        {{template "test-results" .}}
    </div>

    {{template "fullscreen-overlay"}}
    {{template "scripts"}}
</body>
</html>

{{/* ================ Summary Cards ================ */}}
{{define "summary-cards"}}
<div class="summary-grid">
    {{if .Adaptive.Flags.SingleAgentMode}}
    <div class="summary-card agent-info">
        <div class="summary-value">{{.Adaptive.Flags.SingleAgentName}}</div>
        <div class="summary-label"><span class="provider-badge provider-{{.Adaptive.Flags.SingleAgentProvider}}">{{.Adaptive.Flags.SingleAgentProvider}}</span></div>
    </div>
    {{end}}
    <div class="summary-card total">
        <div class="summary-value">{{.Summary.Total}}</div>
        <div class="summary-label">Total Tests</div>
    </div>
    <div class="summary-card passed">
        <div class="summary-value">{{.Summary.Passed}}</div>
        <div class="summary-label">Passed</div>
    </div>
    <div class="summary-card failed">
        <div class="summary-value">{{.Summary.Failed}}</div>
        <div class="summary-label">Failed</div>
    </div>
    {{if gt .Summary.AgentCount 1}}
    <div class="summary-card agents">
        <div class="summary-value">{{.Summary.AgentCount}}</div>
        <div class="summary-label">Agents</div>
    </div>
    {{end}}
    {{if .Adaptive.Flags.ShowSessionHeaders}}
    <div class="summary-card sessions">
        <div class="summary-value">{{.Adaptive.Flags.SessionCount}}</div>
        <div class="summary-label">Sessions</div>
    </div>
    {{end}}
    <div class="summary-card rate">
        <div class="summary-value">{{printf "%.0f%%" .Summary.PassRate}}</div>
        <div class="summary-label">Pass Rate</div>
    </div>
    {{if .Adaptive.Flags.SingleAgentMode}}
    <div class="summary-card tokens">
        <div class="summary-value">{{formatNumber .Summary.TotalTokens}}</div>
        <div class="summary-label">Total Tokens</div>
    </div>
    {{end}}
    {{if gt .Summary.Total 1}}
    <div class="summary-card tokens token-range">
        <div class="summary-value">{{formatTokenRange .Summary.MinTokens .Summary.MaxTokens}}</div>
        <div class="summary-label">Token Range</div>
        <div class="token-bar">
            <span class="token-min">min</span>
            <span class="token-bar-fill"></span>
            <span class="token-max">max</span>
        </div>
    </div>
    {{end}}
    {{if .Adaptive.Flags.SingleAgentMode}}
    <div class="summary-card duration">
        <div class="summary-value">{{printf "%.1fs" .Summary.TotalDuration}}</div>
        <div class="summary-label">Total Duration</div>
    </div>
    {{end}}
    {{if gt .Summary.Total 1}}
    <div class="summary-card duration duration-range">
        <div class="summary-value">{{formatDurationRange .Summary.MinDuration .Summary.MaxDuration}}</div>
        <div class="summary-label">Duration Range</div>
        <div class="duration-bar">
            <span class="duration-min">min</span>
            <span class="duration-bar-fill"></span>
            <span class="duration-max">max</span>
        </div>
    </div>
    {{end}}
</div>
{{end}}

{{/* ================ Test Overview (Single Agent, Multiple Tests) ================ */}}
{{define "test-overview"}}
<section class="section">
    <div class="section-header">
        <h2 class="section-title">üìã Test Overview</h2>
    </div>
    <div class="section-body">
        <div class="matrix-container">
            <table class="comparison-matrix test-overview-table">
                <thead>
                    <tr>
                        <th>Test Name</th>
                        <th>Status</th>
                        <th>Duration</th>
                        <th>Tokens</th>
                        <th>Tools</th>
                        <th>Assertions</th>
                    </tr>
                </thead>
                <tbody>
                    {{range $fileGroup := .TestOverview.FileGroups}}
                    {{if $.TestOverview.ShowFileGroups}}
                    <tr class="matrix-file-header">
                        <td colspan="6">
                            <span class="matrix-group-icon">üìÅ</span> {{$fileGroup.FileName}}
                            <span class="group-stats">‚Äî {{$fileGroup.PassedTests}}/{{$fileGroup.TotalTests}} passed ¬∑ {{printf "%.1f" (divFloat $fileGroup.TotalDuration 1000)}}s ¬∑ {{formatNumber $fileGroup.TotalTokens}} tok</span>
                        </td>
                    </tr>
                    {{end}}
                    {{range $sessionGroup := $fileGroup.SessionGroups}}
                    {{if $.TestOverview.ShowSessionGroups}}
                    <tr class="matrix-session-header">
                        <td colspan="6">
                            <span class="matrix-group-icon">üîÑ</span> {{$sessionGroup.SessionName}}
                            <span class="group-stats">‚Äî {{$sessionGroup.PassedTests}}/{{$sessionGroup.TotalTests}} passed ¬∑ {{printf "%.1f" (divFloat $sessionGroup.TotalDuration 1000)}}s ¬∑ {{formatNumber $sessionGroup.TotalTokens}} tok</span>
                        </td>
                    </tr>
                    {{end}}
                    {{range $test := $sessionGroup.Tests}}
                    <tr class="{{if $test.Passed}}row-passed{{else}}row-failed{{end}} {{if or $.TestOverview.ShowFileGroups $.TestOverview.ShowSessionGroups}}matrix-test-indented{{end}}">
                        <td>{{$test.TestName}}</td>
                        <td>
                            {{if $test.Passed}}
                            <span class="status-badge status-passed">‚úì Passed</span>
                            {{else}}
                            <span class="status-badge status-failed">‚úó Failed</span>
                            {{end}}
                        </td>
                        <td>{{printf "%.1f" (divFloat $test.DurationMs 1000)}}s</td>
                        <td>{{formatNumber $test.TokensUsed}}</td>
                        <td>{{$test.ToolCalls}}</td>
                        <td>{{$test.Assertions}}{{if gt $test.ErrorCount 0}} <span class="error-count">({{$test.ErrorCount}} errors)</span>{{end}}</td>
                    </tr>
                    {{end}}
                    {{end}}
                    {{end}}
                </tbody>
            </table>
        </div>
    </div>
</section>
{{end}}

{{/* ================ Comparison Matrix ================ */}}
{{define "comparison-matrix"}}
<section class="section">
    <div class="section-header">
        <h2 class="section-title">üìä Comparison Matrix</h2>
    </div>
    <div class="section-body">
        <div class="matrix-container">
            <table class="comparison-matrix">
                <thead>
                    <tr>
                        <th>{{if .Matrix.ShowSessionGroups}}Session{{else}}Test{{end}}</th>
                        {{range .Matrix.AgentNames}}
                        <th>{{.}}</th>
                        {{end}}
                    </tr>
                </thead>
                <tbody>
                    {{if or .Matrix.ShowFileGroups .Matrix.ShowSessionGroups}}
                    {{/* Grouped matrix: show file/session headers */}}
                    {{range $fileGroup := .Matrix.FileGroups}}
                    {{if $.Matrix.ShowFileGroups}}
                    <tr class="matrix-file-header">
                        <td colspan="{{add (len $.Matrix.AgentNames) 1}}">
                            <span class="matrix-group-icon">üìÅ</span> {{$fileGroup.FileName}}
                            <span class="group-stats">‚Äî {{$fileGroup.PassedTests}}/{{$fileGroup.TotalTests}} passed ¬∑ {{formatDurationRangeMs $fileGroup.MinDuration $fileGroup.MaxDuration}} ¬∑ {{formatTokenRange $fileGroup.MinTokens $fileGroup.MaxTokens}} tok</span>
                        </td>
                    </tr>
                    {{end}}
                    {{range $sessionGroup := $fileGroup.SessionGroups}}
                    {{if $.Matrix.ShowSessionGroups}}
                    <tr class="matrix-session-header">
                        <td colspan="{{add (len $.Matrix.AgentNames) 1}}">
                            <span class="matrix-group-icon">üîÑ</span> {{$sessionGroup.SessionName}}
                            <span class="group-stats">‚Äî {{$sessionGroup.PassedTests}}/{{$sessionGroup.TotalTests}} passed ¬∑ {{formatDurationRangeMs $sessionGroup.MinDuration $sessionGroup.MaxDuration}} ¬∑ {{formatTokenRange $sessionGroup.MinTokens $sessionGroup.MaxTokens}} tok</span>
                        </td>
                    </tr>
                    {{end}}
                    {{range $testRow := $sessionGroup.TestRows}}
                    <tr class="{{if $.Matrix.ShowSessionGroups}}matrix-test-indented{{end}}{{if and $.Matrix.ShowFileGroups (not $.Matrix.ShowSessionGroups)}}matrix-test-indented{{end}}">
                        <td>{{$testRow.TestName}}</td>
                        {{range $agentName := $.Matrix.AgentNames}}
                        {{$cell := getMatrixCell $.Matrix.Cells $testRow.TestKey $agentName}}
                        <td>
                            {{if $cell.HasResult}}
                            <div class="matrix-cell">
                                <span class="matrix-status">{{if $cell.Passed}}‚úÖ{{else}}‚ùå{{end}}</span>
                                <span class="matrix-duration">{{printf "%.1fs" (divFloat $cell.DurationMs 1000)}}</span>
                                <span class="matrix-tokens">{{formatNumber $cell.Tokens}}</span>
                            </div>
                            {{else}}
                            <span class="text-muted">‚Äî</span>
                            {{end}}
                        </td>
                        {{end}}
                    </tr>
                    {{end}}
                    {{end}}
                    {{end}}
                    {{else}}
                    {{/* Flat matrix: no grouping needed */}}
                    {{range $testKey := .Matrix.TestNames}}
                    <tr>
                        <td>{{getTestDisplayName $.Matrix.TestDisplayNames $testKey}}</td>
                        {{range $agentName := $.Matrix.AgentNames}}
                        {{$cell := getMatrixCell $.Matrix.Cells $testKey $agentName}}
                        <td>
                            {{if $cell.HasResult}}
                            <div class="matrix-cell">
                                <span class="matrix-status">{{if $cell.Passed}}‚úÖ{{else}}‚ùå{{end}}</span>
                                <span class="matrix-duration">{{printf "%.1fs" (divFloat $cell.DurationMs 1000)}}</span>
                                <span class="matrix-tokens">{{formatNumber $cell.Tokens}}</span>
                            </div>
                            {{else}}
                            <span class="text-muted">‚Äî</span>
                            {{end}}
                        </td>
                        {{end}}
                    </tr>
                    {{end}}
                    {{end}}
                </tbody>
            </table>
        </div>
    </div>
</section>
{{end}}

{{/* ================ Agent Leaderboard ================ */}}
{{define "agent-leaderboard"}}
<section class="section">
    <div class="section-header">
        <h2 class="section-title">üèÜ Agent Leaderboard</h2>
    </div>
    <div class="section-body">
        <table class="leaderboard">
            <thead>
                <tr>
                    <th class="rank-col">Rank</th>
                    <th>Agent</th>
                    <th>Success Rate</th>
                    {{if $.Adaptive.Flags.ShowSessionHeaders}}
                    <th>Sessions</th>
                    {{end}}
                    <th>Results</th>
                    <th>Total Tokens</th>
                    <th>Efficiency</th>
                    <th>Total Time</th>
                    <th>Avg Time</th>
                </tr>
            </thead>
            <tbody>
            {{range $agent := .AgentStats}}
                <tr class="{{.RowClass}}">
                    <td class="rank-col">
                        {{if .IsDisqualified}}<span class="rank-badge rank-dq">DQ</span>
                        {{else if eq .Rank 1}}<span class="rank-badge rank-1">ü•á</span>
                        {{else if eq .Rank 2}}<span class="rank-badge rank-2">ü•à</span>
                        {{else if eq .Rank 3}}<span class="rank-badge rank-3">ü•â</span>
                        {{else}}<span class="rank-badge rank-other">{{.Rank}}</span>
                        {{end}}
                    </td>
                    <td>
                        <div class="agent-info">
                            <span class="agent-name">{{.AgentName}}</span>
                            <span class="provider-badge provider-{{.Provider | printf "%s" }}">{{.Provider}}</span>
                        </div>
                    </td>
                    <td>
                        <div class="success-rate-cell">
                            <span class="success-bar"><span class="success-bar-fill {{.SuccessRateClass}}" style="width: {{printf "%.0f" .SuccessRate}}%"></span></span>
                            <span class="stat-value">{{printf "%.0f%%" .SuccessRate}}</span>
                        </div>
                    </td>
                    {{if $.Adaptive.Flags.ShowSessionHeaders}}
                    <td class="stat-value">
                        <span class="session-coverage">{{.SessionsCovered}}/{{.TotalSessions}}</span>
                        <span class="text-muted">({{printf "%.0f%%" .SessionCoverageRate}})</span>
                    </td>
                    {{end}}
                    <td class="results-cell">
                        <span class="result-pass">‚úì{{.PassedTests}}</span>
                        <span class="result-fail">‚úó{{.FailedTests}}</span>
                        {{if gt .ErrorCount 0}}<span class="result-error">‚ö†{{.ErrorCount}}</span>{{end}}
                    </td>
                    <td class="stat-value">{{formatNumber .TotalTokens}}</td>
                    <td class="stat-value {{if .IsDisqualified}}text-muted{{end}}">{{.EfficiencyStr}}</td>
                    <td class="stat-value">{{printf "%.2fs" .TotalDuration}}</td>
                    <td class="stat-value">{{printf "%.2fs" .AvgDuration}}</td>
                </tr>
            {{end}}
            </tbody>
        </table>
        <div class="leaderboard-legend">
            <span class="legend-item"><span class="result-pass">‚úì</span> Passed</span>
            <span class="legend-item"><span class="result-fail">‚úó</span> Failed</span>
            <span class="legend-item"><span class="result-error">‚ö†</span> Errors</span>
            <span class="legend-item"><span class="rank-badge rank-dq">DQ</span> Disqualified (0% success)</span>
        </div>
    </div>
</section>
{{end}}

{{/* ================ File Summary ================ */}}
{{define "file-summary"}}
<section class="section">
    <div class="section-header">
        <h2 class="section-title">üìÅ Test Files Summary</h2>
    </div>
    <div class="section-body">
        <div class="file-summary-list">
            {{range .FileGroups}}
            <div class="file-summary-item {{if eq .SuccessRate 100.0}}file-perfect{{end}}">
                <div class="file-summary-header">
                    <span class="file-name">üìÑ {{.FileName}}</span>
                    <span class="success-bar"><span class="success-bar-fill {{.SuccessRateClass}}" style="width: {{printf "%.0f" .SuccessRate}}%"></span></span>
                    <span class="file-stats">
                        {{.PassedTests}}/{{add .PassedTests .FailedTests}} tests
                        <span class="{{if eq .SuccessRate 100.0}}text-pass{{else if lt .SuccessRate 50.0}}text-fail{{else}}text-muted{{end}}">
                            ({{printf "%.0f" .SuccessRate}}%)
                        </span>
                        <span class="summary-metric">‚è± {{printf "%.1fs" .TotalDuration}}</span>
                        <span class="summary-metric">üî¢ {{formatNumber .TotalTokens}}<span class="tok-suffix">tok</span></span>
                    </span>
                </div>
            </div>
            {{end}}
        </div>
    </div>
</section>
{{end}}

{{/* ================ Test Results ================ */}}
{{define "test-results"}}
<section class="section">
    <div class="section-header">
        <h2 class="section-title">üìã Detailed Test Results</h2>
    </div>
    <div class="section-body">
        <div class="test-list">
            {{/* Use Adaptive hierarchy: File -> Session -> Test */}}
            {{range $fileIdx, $file := .Adaptive.Files}}
            
            {{/* Show file header if multiple files */}}
            {{if $.Adaptive.Flags.ShowFileHeaders}}
            <div class="test-file-header">
                <h3 class="test-file-title">üìÑ {{$file.Name}}</h3>
            </div>
            {{end}}
            
            {{range $sessIdx, $session := $file.Sessions}}
            
            {{/* Wrap entire session (header + tests) in container for visual grouping */}}
            {{if $.Adaptive.Flags.ShowSessionHeaders}}
            <div class="session-container">
            {{$sessData := getSessionByName $.SessionGroups $session.Name}}
            <div class="test-session-header session-group-header">
                <div class="session-header-main">
                    <h4 class="test-session-title">üîÑ {{$session.Name}}</h4>
                    <span class="session-stats">
                        {{if $sessData}}
                        <span class="success-bar"><span class="success-bar-fill {{$sessData.SuccessRateClass}}" style="width: {{printf "%.0f" $sessData.SuccessRate}}%"></span></span>
                        <span class="{{if eq $sessData.SuccessRate 100.0}}text-pass{{else if lt $sessData.SuccessRate 50.0}}text-fail{{else}}text-muted{{end}}">
                            {{$sessData.PassedTests}}/{{add $sessData.PassedTests $sessData.FailedTests}} ({{printf "%.0f%%" $sessData.SuccessRate}})
                        </span>
                        <span class="summary-metric">‚è± {{formatDurationRange $sessData.MinDuration $sessData.MaxDuration}}</span>
                        <span class="summary-metric">üî¢ {{formatTokenRange $sessData.MinTokens $sessData.MaxTokens}}<span class="tok-suffix">tok</span></span>
                        {{if gt $sessData.AgentCount 1}}<span class="summary-metric">ü§ñ {{$sessData.AgentCount}} agents</span>{{end}}
                        {{else}}
                        <span class="success-bar"><span class="success-bar-fill {{$session.SuccessRateClass}}" style="width: {{printf "%.0f" $session.SuccessRate}}%"></span></span>
                        <span class="{{if eq $session.SuccessRate 100.0}}text-pass{{else if lt $session.SuccessRate 50.0}}text-fail{{else}}text-muted{{end}}">
                            {{$session.PassedTests}}/{{$session.TotalTests}} ({{printf "%.0f%%" $session.SuccessRate}})
                        </span>
                        {{end}}
                    </span>
                </div>
                {{/* Session Overview Table - only for multi-agent */}}
                {{if $sessData}}{{if gt (len $sessData.AgentStats) 1}}
                <div class="session-overview-section">
                    <div class="session-overview-label">üìä Session Overview ‚Äî Agent Comparison</div>
                    <div class="session-overview-table-wrapper">
                        <table class="session-overview-table">
                            <thead>
                                <tr>
                                    <th class="metric-col">Metric</th>
                                    {{range $sessData.AgentStats}}
                                    <th class="agent-col {{.SuccessRateClass}}">
                                        <span class="agent-status">{{if eq .SuccessRate 100.0}}‚úÖ{{else if lt .SuccessRate 50.0}}‚ùå{{else}}‚ö†Ô∏è{{end}}</span>
                                        <span class="agent-name">{{.AgentName}}</span>
                                        <span class="provider-badge provider-{{.Provider}}">{{.Provider}}</span>
                                    </th>
                                    {{end}}
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="metric-row">
                                <td class="metric-label">üìä Pass Rate</td>
                                {{range $sessData.AgentStats}}
                                <td class="metric-value {{if eq .SuccessRate 100.0}}text-pass{{else if lt .SuccessRate 50.0}}text-fail{{else}}text-muted{{end}}">
                                    {{.PassedTests}}/{{.TotalTests}} ({{printf "%.0f%%" .SuccessRate}})
                                </td>
                                {{end}}
                            </tr>
                            <tr class="metric-row">
                                <td class="metric-label">‚è±Ô∏è Duration</td>
                                {{range $sessData.AgentStats}}
                                <td class="metric-value">{{formatDurationRange .MinDuration .MaxDuration}}</td>
                                {{end}}
                            </tr>
                            <tr class="metric-row">
                                <td class="metric-label">üéØ Tokens</td>
                                {{range $sessData.AgentStats}}
                                <td class="metric-value">{{formatTokenRange .MinTokens .MaxTokens}}</td>
                                {{end}}
                            </tr>
                        </tbody>
                    </table>
                    </div>
                </div>
                {{end}}{{end}}
                {{if $sessData}}
                {{if $sessData.SequenceDiagram}}
                <details class="session-diagram-details">
                    <summary class="session-diagram-summary">üìä View Session Flow</summary>
                    <div class="session-single-diagram">
                        <div class="agent-sequence-box session-diagram-box">
                            <div class="agent-sequence-header">Session Flow</div>
                            <div class="mermaid">{{$sessData.SequenceDiagram}}</div>
                        </div>
                    </div>
                </details>
                {{else if $sessData.AgentSequenceDiagrams}}
                <details class="session-diagram-details">
                    <summary class="session-diagram-summary">üìä View Session Flow ({{len $sessData.AgentSequenceDiagrams}} agents)</summary>
                    <div class="session-agent-diagrams-grid">
                        {{range $sessData.AgentSequenceDiagrams}}
                        <div class="agent-sequence-box">
                            <div class="agent-sequence-header">{{.AgentName}}</div>
                            <div class="mermaid">{{.Diagram}}</div>
                        </div>
                        {{end}}
                    </div>
                </details>
                {{end}}
                {{end}}
            </div>
            <div class="session-tests-container">
                <div class="session-tests-label">üìã Tests in this session</div>
            {{end}}
            
            {{range $testIdx, $test := $session.Tests}}
            <div class="test-group-section">
                {{template "adaptive-test-group" $test}}
            </div>
            {{end}}
            
            {{if $.Adaptive.Flags.ShowSessionHeaders}}
            </div>{{/* close session-tests-container */}}
            </div>{{/* close session-container */}}
            {{end}}
            {{end}}
            {{end}}
        </div>
    </div>
</section>
{{end}}

{{/* ================ Adaptive Test Group ================ */}}
{{define "adaptive-test-group"}}
<div class="test-group-header">
    <h3 class="test-group-title">{{.Name}}</h3>
    {{if gt (len .Runs) 0}}
    {{with index .Runs 0}}
    {{if .Prompt}}
    <div class="test-group-prompt">
        <span class="prompt-label">üìù Prompt:</span>
        <span class="prompt-text">{{.Prompt}}</span>
    </div>
    {{end}}
    {{end}}
    {{end}}
</div>

{{if gt (len .Runs) 1}}
{{/* Multi-agent view: comparison table + expandable details */}}
{{template "adaptive-multi-agent-comparison" .}}
{{else}}
{{/* Single-agent view: detailed layout */}}
{{range .Runs}}
{{template "single-agent-detail" .}}
{{end}}
{{end}}
{{end}}

{{/* ================ Adaptive Multi-Agent Comparison ================ */}}
{{define "adaptive-multi-agent-comparison"}}
<!-- Multi-agent comparison table (horizontal layout: agents as columns) -->
<div class="comparison-table-wrapper">
    <table class="agent-comparison-table">
        <thead>
            <tr>
                <th class="attribute-col">Metric</th>
                {{range $idx, $run := .Runs}}
                <th class="agent-col {{if $run.Passed}}passed{{else}}failed{{end}}">
                    <span class="agent-status">{{if $run.Passed}}‚úÖ{{else}}‚ùå{{end}}</span>
                    <span class="agent-name">{{$run.AgentName}}</span>
                    <span class="provider-badge provider-{{$run.Provider}}">{{$run.Provider}}</span>
                </th>
                {{end}}
            </tr>
        </thead>
        <tbody>
            <tr class="metric-row">
                <td class="metric-label">‚è±Ô∏è Duration</td>
                {{range .Runs}}
                <td class="metric-value">{{printf "%.2fs" .DurationSeconds}}</td>
                {{end}}
            </tr>
            <tr class="metric-row">
                <td class="metric-label">üéØ Tokens</td>
                {{range .Runs}}
                <td class="metric-value">{{formatNumber .TokensUsed}}</td>
                {{end}}
            </tr>
            <tr class="metric-row">
                <td class="metric-label">üîß Tool Calls</td>
                {{range .Runs}}
                <td class="metric-value">{{len .ToolCalls}}</td>
                {{end}}
            </tr>
            <tr class="metric-row details-row">
                <td class="metric-label">üìã Details</td>
                {{range $idx, $run := .Runs}}
                <td class="metric-value">
                    <button class="details-toggle-btn" onclick="openAgentDetails({{$idx}}, this)" title="Click to view full details">
                        üîç View
                    </button>
                </td>
                {{end}}
            </tr>
        </tbody>
    </table>
</div>

<!-- Side-by-side comparisons -->
{{template "adaptive-tool-comparison" .}}
{{template "adaptive-sequence-comparison" .}}

<!-- Hidden detail panels (content source for overlay) -->
<div class="agent-details-source" style="display: none;">
    {{range $idx, $run := .Runs}}
    <div class="agent-detail-panel" data-agent-idx="{{$idx}}" data-agent-name="{{$run.AgentName}}">
        {{template "single-agent-detail" $run}}
    </div>
    {{end}}
</div>
{{end}}

{{/* ================ Adaptive Tool Calls Comparison ================ */}}
{{define "adaptive-tool-comparison"}}
<details class="tool-comparison-section">
    <summary class="tool-comparison-header">üîß Compare Tool Calls</summary>
    <div class="tool-comparison-content">
        <div class="tool-lists-grid">
            {{range .Runs}}
            <div class="agent-tool-list">
                <div class="agent-tool-header">{{.AgentName}}</div>
                <ol class="tool-sequence">
                    {{range .ToolCalls}}
                    <li class="tool-item">{{.Name}}</li>
                    {{end}}
                    {{if not .ToolCalls}}
                    <li class="no-tools">No tool calls</li>
                    {{end}}
                </ol>
            </div>
            {{end}}
        </div>
    </div>
</details>
{{end}}

{{/* ================ Adaptive Sequence Diagram Comparison ================ */}}
{{define "adaptive-sequence-comparison"}}
<details class="sequence-comparison-section">
    <summary class="sequence-comparison-header">üìä Execution Flow</summary>
    <div class="sequence-comparison-content">
        <div class="sequence-grid">
            {{range .Runs}}
            {{if .SequenceDiagram}}
            <div class="agent-sequence-box">
                <div class="agent-sequence-header">{{.AgentName}}</div>
                <div class="mermaid">{{.SequenceDiagram}}</div>
            </div>
            {{end}}
            {{end}}
        </div>
    </div>
</details>
{{end}}

{{/* ================ Single Agent Detail View ================ */}}
{{define "single-agent-detail"}}
<details class="test-item {{if .Passed}}passed{{else}}failed{{end}}" open>
    <summary class="test-header">
        <div class="test-info">
            <span class="test-status-icon">{{if .Passed}}‚úÖ{{else}}‚ùå{{end}}</span>
            <span class="test-agent">{{.AgentName}}</span>
            <span class="provider-badge">{{.Provider}}</span>
        </div>
        <div class="test-meta">
            <span class="duration">{{printf "%.2fs" .DurationSeconds}}</span>
            <span class="tokens">{{formatNumber .TokensUsed}} tokens</span>
            <span class="expand-icon">‚ñº</span>
        </div>
    </summary>
    <div class="test-details">
        {{template "agent-assertions" .}}
        {{template "agent-errors" .}}
        {{template "agent-clarification-stats" .}}
        {{template "agent-rate-limit-stats" .}}
        {{template "agent-sequence-diagram" .}}
        {{template "agent-tool-calls" .}}
        {{template "agent-messages" .}}
        {{template "agent-final-output" .}}
    </div>
</details>
{{end}}

{{/* ================ Single Agent: Assertions ================ */}}
{{define "agent-assertions"}}
{{if .Assertions}}
<div class="assertions-section">
    <h4 class="subsection-title">Assertions</h4>
    <div class="assertions-list">
        {{range .Assertions}}
        <div class="assertion-item {{if .Passed}}passed{{else}}failed{{end}}">
            <span class="assertion-icon">{{if .Passed}}‚úì{{else}}‚úó{{end}}</span>
            <div class="assertion-content">
                <span class="assertion-type">{{.Type}}</span>
                <span class="assertion-message">{{.Message}}</span>
                {{if and (not .Passed) (hasDetails .Details)}}
                <div class="assertion-details">
                    <pre class="assertion-details-content">{{prettyJSON .Details}}</pre>
                </div>
                {{end}}
            </div>
        </div>
        {{end}}
    </div>
</div>
{{end}}
{{end}}

{{/* ================ Single Agent: Errors ================ */}}
{{define "agent-errors"}}
{{if .Errors}}
<div class="errors-box">
    <div class="errors-title">‚ùå Errors</div>
    {{range .Errors}}
    <div class="error-item">‚Ä¢ {{.}}</div>
    {{end}}
</div>
{{end}}
{{end}}

{{/* ================ Single Agent: Rate Limit Stats ================ */}}
{{define "agent-rate-limit-stats"}}
{{if .RateLimitStats}}
<div class="rate-limit-stats-section">
    <h4 class="subsection-title">‚è±Ô∏è Rate Limit Stats</h4>
    <div class="rate-limit-stats-grid">
        {{if gt .RateLimitStats.ThrottleCount 0}}
        <div class="rate-limit-stat throttle">
            <span class="stat-icon">üö¶</span>
            <div class="stat-content">
                <span class="stat-value">{{.RateLimitStats.ThrottleCount}}</span>
                <span class="stat-label">Throttled</span>
                <span class="stat-detail">{{printf "%.1fs" .RateLimitStats.ThrottleWaitSec}} wait</span>
            </div>
        </div>
        {{end}}
        {{if gt .RateLimitStats.RateLimitHits 0}}
        <div class="rate-limit-stat hits">
            <span class="stat-icon">‚ö†Ô∏è</span>
            <div class="stat-content">
                <span class="stat-value">{{.RateLimitStats.RateLimitHits}}</span>
                <span class="stat-label">429 Hits</span>
            </div>
        </div>
        {{end}}
        {{if gt .RateLimitStats.RetryCount 0}}
        <div class="rate-limit-stat retries">
            <span class="stat-icon">üîÑ</span>
            <div class="stat-content">
                <span class="stat-value">{{.RateLimitStats.RetryCount}}</span>
                <span class="stat-label">Retries</span>
                <span class="stat-detail">{{.RateLimitStats.RetrySuccessCount}} succeeded, {{printf "%.1fs" .RateLimitStats.RetryWaitSec}} wait</span>
            </div>
        </div>
        {{end}}
    </div>
</div>
{{end}}
{{end}}

{{/* ================ Single Agent: Clarification Stats ================ */}}
{{define "agent-clarification-stats"}}
{{if .ClarificationStats}}
<div class="clarification-stats-section">
    <h4 class="subsection-title">ü§î Clarification Requests</h4>
    <div class="clarification-stats-content">
        <div class="clarification-count">
            <span class="stat-icon">‚ùì</span>
            <div class="stat-content">
                <span class="stat-value">{{.ClarificationStats.Count}}</span>
                <span class="stat-label">Clarification{{if gt .ClarificationStats.Count 1}}s{{end}} Detected</span>
                <span class="stat-detail">Iterations: {{range $i, $iter := .ClarificationStats.Iterations}}{{if $i}}, {{end}}#{{$iter}}{{end}}</span>
            </div>
        </div>
        {{if .ClarificationStats.Examples}}
        <div class="clarification-examples">
            {{range .ClarificationStats.Examples}}
            <div class="clarification-example">
                <span class="example-quote">"{{.}}"</span>
            </div>
            {{end}}
        </div>
        {{end}}
    </div>
</div>
{{end}}
{{end}}

{{/* ================ Single Agent: Sequence Diagram ================ */}}
{{define "agent-sequence-diagram"}}
{{if .SequenceDiagram}}
<div class="sequence-section">
    <h4 class="subsection-title">Execution Flow</h4>
    <div class="mermaid">
{{.SequenceDiagram}}
    </div>
</div>
{{end}}
{{end}}

{{/* ================ Single Agent: Tool Calls ================ */}}
{{define "agent-tool-calls"}}
{{if .ToolCalls}}
<div class="toolcalls-section">
    <h4 class="subsection-title">Tool Calls ({{len .ToolCalls}})</h4>
    <div class="timeline">
        {{range .ToolCalls}}
        <div class="timeline-item tool-call">
            <div class="timeline-header">
                <span class="tool-name">üîß {{.Name}}</span>
                <span class="timeline-meta">
                    {{if gt .DurationMs 0}}<span class="tool-duration">{{.DurationMs}}ms</span>{{end}}
                    <span class="timeline-time">{{.Timestamp}}</span>
                </span>
            </div>
            {{if .Parameters}}
            <details class="tool-params-toggle">
                <summary>Parameters</summary>
                <pre class="tool-params">{{prettyJSON .Parameters}}</pre>
            </details>
            {{end}}
            {{if .Result}}
            <details class="tool-result-toggle">
                <summary>Result</summary>
                <pre class="tool-result-content">{{prettyJSON .Result}}</pre>
            </details>
            {{end}}
        </div>
        {{end}}
    </div>
</div>
{{end}}
{{end}}

{{/* ================ Single Agent: Messages ================ */}}
{{define "agent-messages"}}
{{if .Messages}}
<details class="messages-section">
    <summary class="subsection-title">üí¨ Conversation ({{len .Messages}} messages)</summary>
    <div class="conversation-timeline">
        {{range .Messages}}
        <div class="timeline-item {{.Role}}">
            <div class="timeline-header">
                <span class="timeline-role">{{.Role}}</span>
                <span class="timeline-time">{{.Timestamp}}</span>
            </div>
            <div class="timeline-content">{{truncate .Content 1000}}</div>
        </div>
        {{end}}
    </div>
</details>
{{end}}
{{end}}

{{/* ================ Single Agent: Final Output ================ */}}
{{define "agent-final-output"}}
{{if .FinalOutput}}
<details class="final-output-section">
    <summary class="subsection-title">üì§ Final Output</summary>
    <div class="final-output-content">{{.FinalOutput}}</div>
</details>
{{end}}
{{end}}

{{/* ================ Fullscreen Overlay ================ */}}
{{define "fullscreen-overlay"}}
<!-- Sequence Diagram Overlay -->
<div class="sequence-fullscreen-overlay" id="sequenceOverlay" onclick="closeSequenceOverlay(event)">
    <div class="sequence-fullscreen-content" onclick="event.stopPropagation()">
        <div class="sequence-fullscreen-header">
            <span id="sequenceOverlayTitle">Execution Flow</span>
            <span class="sequence-fullscreen-close" onclick="closeSequenceOverlay(event)">‚úï</span>
        </div>
        <div id="sequenceOverlayDiagram"></div>
    </div>
</div>

<!-- Agent Details Overlay -->
<div class="details-fullscreen-overlay" id="detailsOverlay" onclick="closeDetailsOverlay(event)">
    <div class="details-fullscreen-content" onclick="event.stopPropagation()">
        <div class="details-fullscreen-header">
            <span id="detailsOverlayTitle">Agent Details</span>
            <span class="details-fullscreen-close" onclick="closeDetailsOverlay(event)">‚úï</span>
        </div>
        <div id="detailsOverlayContent" class="details-overlay-body"></div>
    </div>
</div>
{{end}}

{{/* ================ Scripts ================ */}}
{{define "scripts"}}
<script>
    // Store original mermaid sources before rendering (for all mermaid elements)
    document.querySelectorAll('.mermaid').forEach(el => {
        el.setAttribute('data-mermaid-source', el.textContent.trim());
    });

    mermaid.initialize({ 
        startOnLoad: true,
        theme: 'neutral',
        securityLevel: 'loose',
        sequence: {
            diagramMarginX: 10,
            diagramMarginY: 10,
            actorMargin: 50,
            width: 150,
            height: 65,
            boxMargin: 10,
            boxTextMargin: 5,
            noteMargin: 10,
            messageMargin: 35
        }
    });

    // Sequence diagram fullscreen functionality
    document.querySelectorAll('.agent-sequence-box').forEach(box => {
        box.addEventListener('click', async function() {
            const agentName = this.querySelector('.agent-sequence-header')?.textContent || 'Execution Flow';
            const mermaidEl = this.querySelector('.mermaid');
            if (!mermaidEl) return;
            
            // Get the stored original source
            const mermaidSrc = mermaidEl.getAttribute('data-mermaid-source');
            if (!mermaidSrc) return;
            
            const overlay = document.getElementById('sequenceOverlay');
            const diagramContainer = document.getElementById('sequenceOverlayDiagram');
            const titleEl = document.getElementById('sequenceOverlayTitle');
            
            titleEl.textContent = agentName;
            
            // Create unique ID for this render
            const uniqueId = 'fullscreen-diagram-' + Date.now();
            
            try {
                // Render with mermaid API for larger, readable diagram
                const { svg } = await mermaid.render(uniqueId, mermaidSrc);
                diagramContainer.innerHTML = svg;
                
                // Scale up the SVG for readability
                const svgEl = diagramContainer.querySelector('svg');
                if (svgEl) {
                    svgEl.style.width = '100%';
                    svgEl.style.minWidth = '800px';
                    svgEl.style.height = 'auto';
                }
            } catch (e) {
                diagramContainer.innerHTML = '<p style="color: red;">Error rendering diagram: ' + e.message + '</p><pre>' + mermaidSrc + '</pre>';
            }
            
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        });
    });

    function closeSequenceOverlay(event) {
        const overlay = document.getElementById('sequenceOverlay');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
    }

    // Open agent details in fullscreen overlay
    function openAgentDetails(agentIdx, btn) {
        const section = btn.closest('.test-group-section');
        const panel = section.querySelector('.agent-detail-panel[data-agent-idx="' + agentIdx + '"]');
        const agentName = panel.getAttribute('data-agent-name');
        
        const overlay = document.getElementById('detailsOverlay');
        const titleEl = document.getElementById('detailsOverlayTitle');
        const contentEl = document.getElementById('detailsOverlayContent');
        
        titleEl.textContent = agentName + ' - Details';
        contentEl.innerHTML = panel.innerHTML;
        
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeDetailsOverlay(event) {
        const overlay = document.getElementById('detailsOverlay');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
    }

    // Re-render mermaid diagrams when details elements are opened
    document.querySelectorAll('details').forEach(details => {
        details.addEventListener('toggle', async function() {
            if (this.open) {
                const unrenderedMermaids = this.querySelectorAll('.mermaid:not([data-processed])');
                for (const el of unrenderedMermaids) {
                    const source = el.getAttribute('data-mermaid-source');
                    if (source) {
                        try {
                            const uniqueId = 'mermaid-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                            const { svg } = await mermaid.render(uniqueId, source);
                            el.innerHTML = svg;
                            el.setAttribute('data-processed', 'true');
                        } catch (e) {
                            console.error('Mermaid render error:', e);
                        }
                    }
                }
            }
        });
    });

    // Close on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeSequenceOverlay();
            closeDetailsOverlay();
        }
    });

    // Render Markdown content for run analysis
    // Execute immediately since script is at end of body (DOM already loaded)
    (function() {
        const markdownElements = document.querySelectorAll('.markdown-content');
        markdownElements.forEach(el => {
            // Get raw text and trim leading/trailing whitespace that comes from HTML indentation
            const rawContent = (el.textContent || el.innerText || '').trim();
            if (rawContent) {
                el.innerHTML = marked.parse(rawContent);
            }
        });
    })();
</script>
{{end}}
